<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileTrackingListener.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.aws</a> &gt; <span class="el_source">FileTrackingListener.java</span></div><h1>FileTrackingListener.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.aws;

import java.io.File;
import java.io.FileNotFoundException;
import java.util.Base64;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.json.Json;
import javax.json.JsonObject;
import javax.naming.ConfigurationException;

import gov.usgs.earthquake.distribution.NotificationEvent;
import gov.usgs.earthquake.distribution.NotificationListener;
import gov.usgs.util.Config;
import gov.usgs.util.DefaultConfigurable;
import gov.usgs.util.FileUtils;
import gov.usgs.util.StreamUtils;

/**
 * This class is a stop-gap to store file-based tracking information in a
 * TrackingIndex.
 *
 * It implements the NotificationListener interface so it can hook into
 * startup/shutdown lifecycle calls used by ProductClient.  Listeners are
 * started before and shutdown after Receivers, and can put a tracking file
 * in place before the receiver starts and save its state after a receiver stops.
 */
public class FileTrackingListener extends DefaultConfigurable implements NotificationListener {

<span class="nc" id="L31">  private static final Logger LOGGER = Logger.getLogger(FileTrackingListener.class.getName());</span>

  // tracking index properties
  public static final String TRACKING_INDEX_PROPERTY = &quot;trackingIndex&quot;;
  public static final String TRACKING_INDEX_FILE_PROPERTY = &quot;trackingIndexFile&quot;;

  // tracking file properties
  public static final String TRACKING_FILE_PROEPRTY = &quot;trackingFile&quot;;

  /** File being tracked. */
  private File trackingFile;
  /** Tracking Index where contents are stored */
  private TrackingIndex trackingIndex;

<span class="nc" id="L45">  public FileTrackingListener() {</span>
<span class="nc" id="L46">  }</span>

<span class="nc" id="L48">  public FileTrackingListener(final File trackingFile, final TrackingIndex trackingIndex) {</span>
<span class="nc" id="L49">    this.trackingFile = trackingFile;</span>
<span class="nc" id="L50">    this.trackingIndex = trackingIndex;</span>
<span class="nc" id="L51">  }</span>

<span class="nc" id="L53">  public File getTrackingFile() { return this.trackingFile; }</span>
  public void setTrackingFile(final File trackingFile) {
<span class="nc" id="L55">    this.trackingFile = trackingFile;</span>
<span class="nc" id="L56">  }</span>

<span class="nc" id="L58">  public TrackingIndex getTrackingIndex() { return this.trackingIndex; }</span>
  public void setTrackingIndex(final TrackingIndex trackingIndex) {
<span class="nc" id="L60">    this.trackingIndex = trackingIndex;</span>
<span class="nc" id="L61">  }</span>

  @Override
  public void configure(Config config) throws Exception {
<span class="nc" id="L65">    super.configure(config);</span>

    // configure tracking index
<span class="nc" id="L68">    final String trackingIndexName = config.getProperty(TRACKING_INDEX_PROPERTY);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">    if (trackingIndexName != null) {</span>
<span class="nc" id="L70">      LOGGER.config(&quot;[&quot; + getName() + &quot;] loading tracking index &quot;</span>
          + trackingIndexName);
      try {
        // read object from global config
<span class="nc" id="L74">        trackingIndex = (TrackingIndex) Config.getConfig().getObject(trackingIndexName);</span>
<span class="nc" id="L75">      } catch (Exception e) {</span>
<span class="nc" id="L76">        LOGGER.log(</span>
            Level.WARNING,
<span class="nc" id="L78">            &quot;[&quot; + getName() + &quot;] error loading tracking index &quot;</span>
                + trackingIndexName,
            e);
<span class="nc" id="L81">      }</span>
    } else {
<span class="nc" id="L83">      final String trackingIndexFileName = config.getProperty(TRACKING_INDEX_FILE_PROPERTY);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">      if (trackingIndexFileName != null) {</span>
<span class="nc" id="L85">        LOGGER.config(&quot;[&quot; + getName() + &quot;] creating tracking index at&quot;</span>
            + trackingIndexFileName);
<span class="nc" id="L87">        trackingIndex = new TrackingIndex(</span>
            TrackingIndex.DEFAULT_DRIVER,
            &quot;jdbc:sqlite:&quot; + trackingIndexFileName);
      }
    }

    // configure tracking file
<span class="nc" id="L94">    final String trackingFileName = config.getProperty(TRACKING_FILE_PROEPRTY);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">    if (trackingFileName == null) {</span>
<span class="nc" id="L96">      throw new ConfigurationException(TRACKING_FILE_PROEPRTY + &quot; is required&quot;);</span>
    }
<span class="nc" id="L98">    trackingFile = new File(trackingFileName);</span>
<span class="nc" id="L99">  }</span>

  /**
   * When starting, call loadTrackingFile to create/update file on disk.
   */
  @Override
  public void startup() throws Exception {
<span class="nc" id="L106">    super.startup();</span>
<span class="nc" id="L107">    trackingIndex.startup();</span>
<span class="nc" id="L108">    loadTrackingFile();</span>
<span class="nc" id="L109">  }</span>

  /**
   * When shutting down, call storeTrackingFile to read from file on disk.
   */
  @Override
  public void shutdown() throws Exception {
<span class="nc" id="L116">    storeTrackingFile();</span>
<span class="nc" id="L117">    trackingIndex.shutdown();</span>
<span class="nc" id="L118">    super.shutdown();</span>
<span class="nc" id="L119">  }</span>

  /**
   * Read trackingIndex and write trackingFile.
   *
   * @throws Exception
   */
  public void loadTrackingFile() throws Exception {
<span class="nc" id="L127">    final String name = trackingFile.getAbsolutePath();</span>
<span class="nc" id="L128">    final JsonObject trackingData = trackingIndex.getTrackingData(name);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">    if (trackingData == null) {</span>
<span class="nc" id="L130">      LOGGER.info(&quot;[&quot; + getName() + &quot;] tracking data not found in index, ignoring&quot;);</span>
<span class="nc" id="L131">      return;</span>
    }
<span class="nc" id="L133">    final byte[] data = Base64.getDecoder().decode(trackingData.getString(&quot;data&quot;));</span>
<span class="nc" id="L134">    FileUtils.writeFile(trackingFile, data);</span>
<span class="nc" id="L135">  }</span>

  /**
   * Read trackingFile and write into trackingIndex.
   *
   * @throws Exception
   */
  public void storeTrackingFile() throws Exception {
    try {
      // use absolute path as name
<span class="nc" id="L145">      final String name = trackingFile.getAbsolutePath();</span>
<span class="nc" id="L146">      final byte[] data = StreamUtils.readStream(trackingFile);</span>
<span class="nc" id="L147">      final JsonObject trackingData = Json.createObjectBuilder()</span>
<span class="nc" id="L148">          .add(&quot;name&quot;, name)</span>
<span class="nc" id="L149">          .add(&quot;data&quot;, Base64.getEncoder().encodeToString(data))</span>
<span class="nc" id="L150">          .build();</span>
<span class="nc" id="L151">      trackingIndex.setTrackingData(trackingFile.getAbsolutePath(), trackingData);</span>
<span class="nc" id="L152">    } catch (FileNotFoundException fnf) {</span>
<span class="nc" id="L153">      LOGGER.info(&quot;[&quot; + getName() + &quot;] tracking file not found, ignoring&quot;);</span>
<span class="nc" id="L154">    }</span>
<span class="nc" id="L155">  }</span>

  /**
   * Notification Listener method stubs.
   * These are used only to gain access to lifecycle hooks above.
   */

  @Override
  public void onNotification(NotificationEvent event) throws Exception {
    // ignore
<span class="nc" id="L165">  }</span>

  @Override
  public int getMaxTries() {
<span class="nc" id="L169">    return 1;</span>
  }

  @Override
  public long getTimeout() {
<span class="nc" id="L174">    return 1;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>