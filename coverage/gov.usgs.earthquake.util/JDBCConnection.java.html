<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JDBCConnection.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.util</a> &gt; <span class="el_source">JDBCConnection.java</span></div><h1>JDBCConnection.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.util;

import gov.usgs.util.Config;
import gov.usgs.util.DefaultConfigurable;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Utility class for JDBC Connection.
 *
 * Sub-classes must implement the connect method, and extend startup and
 * shutdown methods. The {@link #verifyConnection()} method tests whether the
 * connection is active, and will shutdown() and startup() to reinitialize if it
 * is not active.
 *
 * @author jmfee
 */
public class JDBCConnection extends DefaultConfigurable implements AutoCloseable {

<span class="fc" id="L25">	private static final Logger LOGGER = Logger.getLogger(JDBCConnection.class</span>
<span class="fc" id="L26">			.getName());</span>

	/** Connection object. */
	private Connection connection;

	/** JDBC driver class. */
	private String driver;

	/** JDBC connect url. */
	private String url;

	/**
	 * Create a new JDBCConnection object.
	 */
<span class="fc" id="L40">	public JDBCConnection() {</span>
<span class="fc" id="L41">		this.connection = null;</span>
<span class="fc" id="L42">	}</span>

<span class="fc" id="L44">	public JDBCConnection(final String driver, final String url) {</span>
<span class="fc" id="L45">		this.driver = driver;</span>
<span class="fc" id="L46">		this.url = url;</span>
<span class="fc" id="L47">	}</span>

	/**
	 * Implement autocloseable.
	 *
	 * Calls {@link #shutdown()}.
	 *
	 * @throws Exception
	 */
	@Override
	public void close() throws Exception {
<span class="fc" id="L58">		shutdown();</span>
<span class="fc" id="L59">	}</span>

	/**
	 * Implement Configurable
	 */
	@Override
	public void configure(final Config config) throws Exception {
<span class="fc" id="L66">		setDriver(config.getProperty(&quot;driver&quot;));</span>
<span class="fc" id="L67">		setUrl(config.getProperty(&quot;url&quot;));</span>
<span class="fc" id="L68">	}</span>

	/**
	 * Connect to the database.
	 *
	 * Sub-classes determine how connection is made.
	 *
	 * @return the connection.
	 * @throws Exception
	 *             if unable to connect.
	 */
	protected Connection connect() throws Exception {
		// load driver if needed
<span class="fc" id="L81">		Class.forName(driver);</span>
<span class="fc" id="L82">		final Connection conn = DriverManager.getConnection(url);</span>
<span class="fc" id="L83">		return conn;</span>
	}

	/**
	 * Initialize the database connection.
	 *
	 * Sub-classes should call super.startup(), before preparing any statements.
	 */
	@Override
	public void startup() throws Exception {
<span class="fc" id="L93">		this.connection = connect();</span>
<span class="fc" id="L94">	}</span>

	/**
	 * Shutdown the database connection.
	 *
	 * Sub-classes should close any prepared statements (catching any
	 * exceptions), and then call super.shutdown() to close the database
	 * connection.
	 */
	@Override
	public void shutdown() throws Exception {
		try {
<span class="fc bfc" id="L106" title="All 2 branches covered.">			if (connection != null) {</span>
<span class="fc" id="L107">				connection.close();</span>
			}
<span class="nc" id="L109">		} catch (Exception e) {</span>
			// log
<span class="nc" id="L111">			e.printStackTrace();</span>
		} finally {
<span class="fc" id="L113">			connection = null;</span>
		}
<span class="fc" id="L115">	}</span>

	/**
	 * Open a transaction on the database connection
	 */
	public synchronized void beginTransaction() throws Exception {
<span class="fc" id="L121">		Connection conn = this.verifyConnection();</span>
<span class="fc" id="L122">		conn.setAutoCommit(false);</span>
<span class="fc" id="L123">	}</span>

	/**
	 * Finalize the transaction by committing all the changes and closing the
	 * transaction.
	 */
	public synchronized void commitTransaction() throws Exception {
<span class="fc" id="L130">		getConnection().setAutoCommit(true);</span>
<span class="fc" id="L131">	}</span>

	/**
	 * Undo all of the changes made during the current transaction
	 */
	public synchronized void rollbackTransaction() throws Exception {
<span class="fc" id="L137">		getConnection().rollback();</span>
<span class="fc" id="L138">	}</span>

	/**
	 * @return current connection object, or null if not connected.
	 */
	public Connection getConnection() {
<span class="fc" id="L144">		return this.connection;</span>
	}

	/**
	 * Check whether database connection is closed, and reconnect if needed.
	 *
	 * Executes the query &quot;select 1&quot; using the current database connection. If
	 * this doesn't succeed, reinitializes the database connection by calling
	 * shutdown() then startup().
	 *
	 * @return Valid connection object.
	 * @throws Exception
	 *             if unable to (re)connect.
	 */
	public synchronized Connection verifyConnection() throws Exception {
		try {
			// usually throws an exception when connection is closed
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">			if (connection.isClosed()) {</span>
<span class="nc" id="L162">				shutdown();</span>
			}
<span class="fc" id="L164">		} catch (Exception e) {</span>
<span class="fc" id="L165">			shutdown();</span>
<span class="fc" id="L166">		}</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">		if (connection == null) {</span>
			// connection is null after shutdown()
<span class="fc" id="L170">			startup();</span>
		}

		// isClosed() doesn't check if we can still communicate with the server.
		// current mysql driver doesn't implement isValid(), so check manually.
<span class="fc" id="L175">		String query_text = &quot;SELECT 1&quot;;</span>

		try {
<span class="fc" id="L178">			Statement statement = null;</span>
<span class="fc" id="L179">			ResultSet results = null;</span>
			try {
<span class="fc" id="L181">				statement = connection.createStatement();</span>
<span class="fc" id="L182">				results = statement.executeQuery(query_text);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">				while (results.next()) {</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">					if (results.getInt(1) != 1) {</span>
<span class="nc" id="L185">						throw new Exception(&quot;[&quot; + getName()</span>
								+ &quot;] Problem checking database connection&quot;);
					}
				}
			} finally {
				// close result and statement no matter what
				try {
<span class="fc" id="L192">					results.close();</span>
<span class="nc" id="L193">				} catch (Exception e2) {</span>
					// ignore
<span class="fc" id="L195">				}</span>
				try {
<span class="fc" id="L197">					statement.close();</span>
<span class="nc" id="L198">				} catch (Exception e2) {</span>
					// ignore
<span class="fc" id="L200">				}</span>
			}
<span class="nc" id="L202">		} catch (Exception e) {</span>
			// The connection was dead, so lets try to restart it
<span class="nc" id="L204">			LOGGER.log(Level.FINE, &quot;[&quot; + getName()</span>
					+ &quot;] Restarting database connection&quot;);
<span class="nc" id="L206">			shutdown();</span>
<span class="nc" id="L207">			startup();</span>
<span class="fc" id="L208">		}</span>

<span class="fc" id="L210">		return this.connection;</span>
	}

<span class="fc" id="L213">	public String getDriver() { return this.driver; }</span>
<span class="fc" id="L214">	public void setDriver(final String driver) { this.driver = driver; }</span>

<span class="fc" id="L216">	public String getUrl() { return this.url; }</span>
<span class="fc" id="L217">	public void setUrl(final String url) { this.url = url; }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>