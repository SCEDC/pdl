<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JDBCConnection.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.util</a> &gt; <span class="el_source">JDBCConnection.java</span></div><h1>JDBCConnection.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.util;

import gov.usgs.util.DefaultConfigurable;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;

import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Utility class for JDBC Connection.
 *
 * Sub-classes must implement the connect method, and extend startup and
 * shutdown methods. The {@link #verifyConnection()} method tests whether the
 * connection is active, and will shutdown() and startup() to reinitialize if it
 * is not active.
 *
 * @author jmfee
 */
public abstract class JDBCConnection extends DefaultConfigurable {

<span class="fc" id="L24">	private static final Logger LOGGER = Logger.getLogger(JDBCConnection.class</span>
<span class="fc" id="L25">			.getName());</span>

	/** Connection object. */
	private Connection connection;

	/**
	 * Create a new JDBCConnection object.
	 */
<span class="fc" id="L33">	public JDBCConnection() {</span>
<span class="fc" id="L34">		this.connection = null;</span>
<span class="fc" id="L35">	}</span>

	/**
	 * Connect to the database.
	 *
	 * Sub-classes determine how connection is made.
	 *
	 * @return the connection.
	 * @throws Exception
	 *             if unable to connect.
	 */
	protected abstract Connection connect() throws Exception;

	/**
	 * Initialize the database connection.
	 *
	 * Sub-classes should call super.startup(), before preparing any statements.
	 */
	@Override
	public void startup() throws Exception {
<span class="fc" id="L55">		this.connection = connect();</span>
<span class="fc" id="L56">	}</span>

	/**
	 * Shutdown the database connection.
	 *
	 * Sub-classes should close any prepared statements (catching any
	 * exceptions), and then call super.shutdown() to close the database
	 * connection.
	 */
	@Override
	public void shutdown() throws Exception {
		try {
<span class="fc bfc" id="L68" title="All 2 branches covered.">			if (connection != null) {</span>
<span class="fc" id="L69">				connection.close();</span>
			}
<span class="nc" id="L71">		} catch (Exception e) {</span>
			// log
<span class="nc" id="L73">			e.printStackTrace();</span>
		} finally {
<span class="fc" id="L75">			connection = null;</span>
		}
<span class="fc" id="L77">	}</span>

	/**
	 * Open a transaction on the database connection
	 */
	public synchronized void beginTransaction() throws Exception {
<span class="fc" id="L83">		Connection conn = this.verifyConnection();</span>
<span class="fc" id="L84">		conn.setAutoCommit(false);</span>
<span class="fc" id="L85">	}</span>

	/**
	 * Finalize the transaction by committing all the changes and closing the
	 * transaction.
	 */
	public synchronized void commitTransaction() throws Exception {
<span class="fc" id="L92">		getConnection().setAutoCommit(true);</span>
<span class="fc" id="L93">	}</span>

	/**
	 * Undo all of the changes made during the current transaction
	 */
	public synchronized void rollbackTransaction() throws Exception {
<span class="fc" id="L99">		getConnection().rollback();</span>
<span class="fc" id="L100">	}</span>

	/**
	 * @return current connection object, or null if not connected.
	 */
	public Connection getConnection() {
<span class="fc" id="L106">		return this.connection;</span>
	}

	/**
	 * Check whether database connection is closed, and reconnect if needed.
	 *
	 * Executes the query &quot;select 1&quot; using the current database connection. If
	 * this doesn't succeed, reinitializes the database connection by calling
	 * shutdown() then startup().
	 *
	 * @return Valid connection object.
	 * @throws Exception
	 *             if unable to (re)connect.
	 */
	public synchronized Connection verifyConnection() throws Exception {
		try {
			// usually throws an exception when connection is closed
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			if (connection.isClosed()) {</span>
<span class="nc" id="L124">				shutdown();</span>
			}
<span class="fc" id="L126">		} catch (Exception e) {</span>
<span class="fc" id="L127">			shutdown();</span>
<span class="fc" id="L128">		}</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">		if (connection == null) {</span>
			// connection is null after shutdown()
<span class="fc" id="L132">			startup();</span>
		}

		// isClosed() doesn't check if we can still communicate with the server.
		// current mysql driver doesn't implement isValid(), so check manually.
<span class="fc" id="L137">		String query_text = &quot;SELECT 1&quot;;</span>

		try {
<span class="fc" id="L140">			Statement statement = null;</span>
<span class="fc" id="L141">			ResultSet results = null;</span>
			try {
<span class="fc" id="L143">				statement = connection.createStatement();</span>
<span class="fc" id="L144">				results = statement.executeQuery(query_text);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">				while (results.next()) {</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">					if (results.getInt(1) != 1) {</span>
<span class="nc" id="L147">						throw new Exception(&quot;[&quot; + getName()</span>
								+ &quot;] Problem checking database connection&quot;);
					}
				}
			} finally {
				// close result and statement no matter what
				try {
<span class="fc" id="L154">					results.close();</span>
<span class="nc" id="L155">				} catch (Exception e2) {</span>
					// ignore
<span class="fc" id="L157">				}</span>
				try {
<span class="fc" id="L159">					statement.close();</span>
<span class="nc" id="L160">				} catch (Exception e2) {</span>
					// ignore
<span class="fc" id="L162">				}</span>
			}
<span class="nc" id="L164">		} catch (Exception e) {</span>
			// The connection was dead, so lets try to restart it
<span class="nc" id="L166">			LOGGER.log(Level.FINE, &quot;[&quot; + getName()</span>
					+ &quot;] Restarting database connection&quot;);
<span class="nc" id="L168">			shutdown();</span>
<span class="nc" id="L169">			startup();</span>
<span class="fc" id="L170">		}</span>

<span class="fc" id="L172">		return this.connection;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>