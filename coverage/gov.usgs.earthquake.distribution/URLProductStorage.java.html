<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>URLProductStorage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.distribution</a> &gt; <span class="el_source">URLProductStorage.java</span></div><h1>URLProductStorage.java</h1><pre class="source lang-java linenums">/*
 * URLProductStorage
 */
package gov.usgs.earthquake.distribution;

import gov.usgs.earthquake.product.ProductId;

import gov.usgs.earthquake.product.io.BinaryProductHandler;
import gov.usgs.earthquake.product.io.BinaryProductSource;
import gov.usgs.earthquake.product.io.JsonProductHandler;
import gov.usgs.earthquake.product.io.JsonProductSource;
import gov.usgs.earthquake.product.io.ProductSource;
import gov.usgs.earthquake.product.io.ProductHandler;
import gov.usgs.earthquake.product.io.XmlProductSource;
import gov.usgs.earthquake.product.io.XmlProductHandler;
import gov.usgs.util.Config;
import gov.usgs.util.StreamUtils;

import java.io.File;
import java.io.InputStream;
import java.io.OutputStream;

import java.net.URL;
import java.util.logging.Logger;

/**
 * Store products in a file system which is also available at a URL.
 */
public class URLProductStorage extends FileProductStorage {

<span class="fc" id="L31">	public enum Format {</span>
<span class="fc" id="L32">		BINARY(&quot;bin&quot;),</span>
<span class="fc" id="L33">		JSON(&quot;json&quot;),</span>
<span class="fc" id="L34">		XML(&quot;xml&quot;);</span>

		private String value;

<span class="fc" id="L38">		private Format(final String value) {</span>
<span class="fc" id="L39">			this.value = value;</span>
<span class="fc" id="L40">		}</span>

		public String toString() {
<span class="fc" id="L43">			return this.value;</span>
		}

		public static Format fromString(final String value) {
<span class="nc bnc" id="L47" title="All 2 branches missed.">			if (BINARY.value.equals(value)) {</span>
<span class="nc" id="L48">				return BINARY;</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">			} else if (JSON.value.equals(value)) {</span>
<span class="nc" id="L50">				return JSON;</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">			} else if (XML.value.equals(value)) {</span>
<span class="nc" id="L52">				return XML;</span>
			} else {
<span class="nc" id="L54">				throw new IllegalArgumentException(&quot;Invalid format&quot;);</span>
			}
		}
	};

<span class="fc" id="L59">	private static final Logger LOGGER = Logger</span>
<span class="fc" id="L60">			.getLogger(URLProductStorage.class.getName());</span>

	/** Property name representing base URL. */
	public static final String URL_PROPERTY_NAME = &quot;url&quot;;

	/** The URL which corresponds to baseDirectory. */
	private URL baseURL;

	public static final String STORAGE_FORMAT_PROPERTY = &quot;storageFormat&quot;;

	public static final String STORAGE_PATH_PROPERTY = &quot;storagePath&quot;;
	public static final String DEFAULT_STORAGE_PATH = &quot;{source}_{type}_{code}_{updateTime}.{format}&quot;;

	/** (Deprecated, use STORAGE_PATH) Property name to configure binary or xml format. */
	public static final String BINARY_FORMAT_PROPERTY = &quot;binaryFormat&quot;;
	/** Default value for whether to use binary format. */
	public static final String BINARY_FORMAT_DEFAULT = &quot;false&quot;;

<span class="pc" id="L78">	private Format storageFormat = Format.XML;</span>
<span class="pc" id="L79">	private String storagePath = DEFAULT_STORAGE_PATH;</span>

	/**
	 * Constructor for the Configurable interface.
	 */
<span class="nc" id="L84">	public URLProductStorage() {</span>
<span class="nc" id="L85">	}</span>

	/**
	 * Construct a new ProductStorage object
	 *
	 * @param baseDirectory
	 *            the storage directory where products are stored.
	 * @param baseURL
	 *            the url where storage directory is available.
	 */
	public URLProductStorage(final File baseDirectory, final URL baseURL) {
<span class="fc" id="L96">		super(baseDirectory);</span>
<span class="fc" id="L97">		this.baseURL = baseURL;</span>
<span class="fc" id="L98">	}</span>

	/**
	 * Load the baseURL from configuration.
	 *
	 * @param config
	 *            the configuration object.
	 */
	public void configure(final Config config) throws Exception {
<span class="nc" id="L107">		super.configure(config);</span>

<span class="nc" id="L109">		String urlString = config.getProperty(URL_PROPERTY_NAME);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (urlString == null) {</span>
<span class="nc" id="L111">			throw new ConfigurationException(&quot;[&quot; + getName()</span>
					+ &quot;] 'url' is a required configuration property&quot;);
		}
<span class="nc" id="L114">		baseURL = new URL(urlString);</span>
<span class="nc" id="L115">		LOGGER.config(&quot;[&quot; + getName() + &quot;] base url is '&quot; + baseURL.toString()</span>
				+ &quot;'&quot;);

<span class="nc" id="L118">		String format = config.getProperty(STORAGE_FORMAT_PROPERTY);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (format != null) {</span>
<span class="nc" id="L120">			storageFormat = Format.fromString(format);</span>
		} else {
<span class="nc bnc" id="L122" title="All 2 branches missed.">			if (Boolean.valueOf(config.getProperty(</span>
					BINARY_FORMAT_PROPERTY,
					BINARY_FORMAT_DEFAULT))) {
<span class="nc" id="L125">				storageFormat = Format.BINARY;</span>
			} else {
<span class="nc" id="L127">				storageFormat = Format.XML;</span>
			}
		}
<span class="nc" id="L130">		LOGGER.config(&quot;[&quot; + getName() + &quot;] using format &quot; + storageFormat);</span>

<span class="nc" id="L132">		storagePath = config.getProperty(STORAGE_PATH_PROPERTY, DEFAULT_DIRECTORY);</span>
<span class="nc" id="L133">		LOGGER.config(&quot;[&quot; + getName() + &quot;] using path &quot; + storagePath);</span>
<span class="nc" id="L134">	}</span>

	/**
	 * Compute the URL to a product.
	 *
	 * @param id
	 *            which product.
	 * @return the URL to a product.
	 * @throws Exception
	 */
	public URL getProductURL(final ProductId id) throws Exception {
<span class="fc" id="L145">		return new URL(baseURL, getProductPath(id));</span>
	}

	/**
	 * A method for subclasses to override the storage path.
	 *
	 * The returned path is appended to the base directory when storing and
	 * retrieving products.
	 *
	 * @param id
	 *            the product id to convert.
	 * @return the directory used to store id.
	 */
	@Override
	public String getProductPath(final ProductId id) {
<span class="fc" id="L160">		String path = storagePath;</span>
<span class="fc" id="L161">		path = path.replace(&quot;{source}&quot;, id.getSource());</span>
<span class="fc" id="L162">		path = path.replace(&quot;{type}&quot;, id.getType());</span>
<span class="fc" id="L163">		path = path.replace(&quot;{code}&quot;, id.getCode());</span>
<span class="fc" id="L164">		path = path.replace(&quot;{updateTime}&quot;, Long.toString(id.getUpdateTime().getTime()));</span>
<span class="fc" id="L165">		path = path.replace(&quot;{format}&quot;, storageFormat.toString());</span>
<span class="fc" id="L166">		return path;</span>
	}

	/**
	 * A method for subclasses to override the storage format.
	 *
	 * When overriding this method, the method getProductInputForFile should
	 * also be overridden.
	 *
	 * @param file
	 *            a file that should be converted into a ProductOutput.
	 * @return the ProductOutput.
	 */
	protected ProductHandler getProductHandlerFormat(final File file)
			throws Exception {
<span class="fc" id="L181">		OutputStream out = StreamUtils.getOutputStream(file);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">		if (storageFormat == Format.BINARY) {</span>
<span class="nc" id="L183">			return new BinaryProductHandler(out);</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">		} else if (storageFormat == Format.JSON) {</span>
<span class="nc" id="L185">			return new JsonProductHandler(out);</span>
		} else {
<span class="fc" id="L187">			return new XmlProductHandler(out);</span>
		}
	}

	/**
	 * A method for subclasses to override the storage format.
	 *
	 * When overriding this method, the method getProductOutputForFile should
	 * also be overridden.
	 *
	 * @param file
	 *            a file that should be converted into a ProductInput.
	 * @return the ProductInput.
	 */
	protected ProductSource getProductSourceFormat(final File file)
			throws Exception {
<span class="fc" id="L203">		InputStream in = StreamUtils.getInputStream(file);</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">		if (storageFormat == Format.BINARY) {</span>
<span class="nc" id="L205">			return new BinaryProductSource(in);</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">		} else if (storageFormat == Format.JSON) {</span>
<span class="nc" id="L207">			return new JsonProductSource(in);</span>
		} else {
<span class="fc" id="L209">			return new XmlProductSource(in);</span>
		}
	}

	public Format getStorageFormat() {
<span class="nc" id="L214">		return this.storageFormat;</span>
	}

	public void setStorageFormat(final Format format) {
<span class="nc" id="L218">		this.storageFormat = format;</span>
<span class="nc" id="L219">	}</span>

	public String getStoragePath() {
<span class="nc" id="L222">		return this.storagePath;</span>
	}

	public void setStoragePath(final String path) {
<span class="nc" id="L226">		this.storagePath = path;</span>
<span class="nc" id="L227">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>