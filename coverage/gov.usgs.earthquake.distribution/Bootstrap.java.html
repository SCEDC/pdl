<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Bootstrap.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.distribution</a> &gt; <span class="el_source">Bootstrap.java</span></div><h1>Bootstrap.java</h1><pre class="source lang-java linenums">/*
 * Bootstrap
 */
package gov.usgs.earthquake.distribution;

import gov.usgs.util.Config;
import gov.usgs.util.Configurable;
import gov.usgs.util.StreamUtils;
import gov.usgs.util.logging.LoggingOutputStream;
import gov.usgs.util.logging.SimpleLogFileHandler;
import gov.usgs.util.logging.SimpleLogFormatter;
import gov.usgs.util.logging.StdOutErrLevel;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintStream;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.logging.ConsoleHandler;
import java.util.logging.Formatter;
import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.LogManager;
import java.util.logging.Logger;
import java.util.logging.SimpleFormatter;
import java.util.logging.XMLFormatter;

/**
 * Bootstrap is a class used to start an application.
 *
 * It loads a configuration file, sets up initial logging, and starts a
 * configurable main method.
 *
 * @author jmfee
 *
 */
public class Bootstrap {

	// public static
	static {
<span class="nc" id="L42">		gov.usgs.util.protocolhandlers.data.Handler.register();</span>
	}

	/** Default JAR config path. */
	public static final String JAR_CONFIGFILE = &quot;etc/config/config.ini&quot;;

	/** Argument for config file. */
	public static final String CONFIGFILE_ARGUMENT = &quot;--configFile=&quot;;
	/** Default config file. */
	public static final String DEFAULT_CONFIGFILE = &quot;config.ini&quot;;

	/** Whether to test config only. */
	public static final String CONFIG_TEST_ARGUMENT = &quot;--configTest&quot;;

	/** Property for log format. */
	public static final String LOGFORMAT_PROPERTY_NAME = &quot;logformat&quot;;
	/** log format value for &quot;pdl&quot; format */
	public static final String LOGFORMAT_PDL = &quot;pdl&quot;;
	/** log format value for java &quot;simple&quot; format */
	public static final String LOGFORMAT_SIMPLE = &quot;simple&quot;;
	/** log format value for java &quot;xml&quot; format */
	public static final String LOGFORMAT_XML = &quot;xml&quot;;
	/** Default log format is &quot;simple&quot;. */
	public static final String DEFAULT_LOGFORMAT = LOGFORMAT_PDL;

	/** Property for log level. */
	public static final String LOGLEVEL_PROPERTY_NAME = &quot;loglevel&quot;;
	/** Default log level is &quot;INFO&quot;. */
	public static final String DEFAULT_LOGLEVEL = &quot;INFO&quot;;

	/** Property for log directory. */
	public static final String LOGDIRECTORY_PROPERTY_NAME = &quot;logdirectory&quot;;
	/** Default log directory is &quot;log&quot;. */
	public static final String DEFAULT_LOGDIRECTORY = &quot;log&quot;;

	/** Property for log file pattern. */
	public static final String LOGFILE_PROPERTY_NAME = &quot;logfile&quot;;
	/** Default log file pattern is &quot;yyyyMMdd'.log'&quot;. */
	public static final String DEFAULT_LOGFILE = &quot;yyyyMMdd'.log'&quot;;

	/** Property for console redirect. */
	public static final String CONSOLEREDIRECT_PROPERTY_NAME = &quot;redirectconsole&quot;;
	/** Default console redirect value is &quot;false&quot; (don't redirect). */
	public static final String DEFAULT_CONSOLEREDIRECT = &quot;false&quot;;

	/** Property used to disable tracker updates. */
	public static final String ENABLE_TRACKER_PROPERTY_NAME = &quot;enableTracker&quot;;

	/** Argument for mainclass. */
	public static final String MAINCLASS_ARGUMENT = &quot;--mainclass=&quot;;
	/** Property for mainclass. */
	public static final String MAINCLASS_PROPERTY_NAME = &quot;mainclass&quot;;
	/** Default mainclass is &quot;gov.usgs.earthquake.distribution.ProductClient. */
	public static final String DEFAULT_MAINCLASS = &quot;gov.usgs.earthquake.distribution.ProductClient&quot;;

	public static final String VERSION_ARGUMENT = &quot;--version&quot;;

	// private static

	/** Private logging object. */
<span class="nc" id="L102">	private static final Logger LOGGER = Logger.getLogger(Bootstrap.class</span>
<span class="nc" id="L103">			.getName());</span>


	/** List of logger objects that have level overrides configured. */
<span class="nc" id="L107">	private final ArrayList&lt;Logger&gt; loggers = new ArrayList&lt;Logger&gt;();</span>

	// constructors

<span class="nc" id="L111">	public Bootstrap() {</span>
<span class="nc" id="L112">	}</span>

	// members

	/**
	 * Read configuration from inside jar file, and configFile.
	 *
	 * @param configFile
	 *            config file to load.
	 * @throws IOException
	 */
	public Config loadConfig(final File configFile) throws IOException {
<span class="nc" id="L124">		Config config = new Config();</span>

		// load defaults from jar file
<span class="nc" id="L127">		InputStream in = Bootstrap.class.getClassLoader().getResourceAsStream(</span>
				JAR_CONFIGFILE);
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (in != null) {</span>
			try {
<span class="nc" id="L131">				config.load(in);</span>
			} finally {
<span class="nc" id="L133">				StreamUtils.closeStream(in);</span>
<span class="nc" id="L134">			}</span>
		} else {
<span class="nc" id="L136">			LOGGER.config(&quot;Jar configuration not found&quot;);</span>
		}

		// override settings with a config file
<span class="nc bnc" id="L140" title="All 2 branches missed.">		if (configFile.exists()) {</span>
<span class="nc" id="L141">			LOGGER.config(&quot;Loading configuration file &quot;</span>
<span class="nc" id="L142">					+ configFile.getCanonicalPath());</span>

<span class="nc" id="L144">			config = new Config(config);</span>
<span class="nc" id="L145">			in = StreamUtils.getInputStream(configFile);</span>
			try {
<span class="nc" id="L147">				config.load(in);</span>
			} finally {
<span class="nc" id="L149">				StreamUtils.closeStream(in);</span>
			}
		}

<span class="nc" id="L153">		return config;</span>
	}

	public void setupLogging(final Config config) {
<span class="nc" id="L157">		final LogManager logManager = LogManager.getLogManager();</span>
<span class="nc" id="L158">		logManager.reset();</span>
<span class="nc" id="L159">		loggers.clear();</span>

		// logging is noisy without this
<span class="nc bnc" id="L162" title="All 2 branches missed.">		for (final String name : new String[]{</span>
			&quot;com.sun.activation&quot;,
			&quot;com.sun.xml.bind&quot;,
			&quot;javax.xml.bind&quot;,
			&quot;org.glassfish.grizzly&quot;,
			&quot;org.glassfish.tyrus&quot;,
			&quot;sun.awt.X11.timeoutTask.XToolkit&quot;
		}) {
<span class="nc" id="L170">			final Logger logger = Logger.getLogger(name);</span>
<span class="nc" id="L171">			logger.setLevel(Level.INFO);</span>
			// save reference to logger since LogManager uses weakref
<span class="nc" id="L173">			loggers.add(logger);</span>
		};

<span class="nc" id="L176">		final Level level = Level.parse(config.getProperty(LOGLEVEL_PROPERTY_NAME,</span>
				DEFAULT_LOGLEVEL));
<span class="nc" id="L178">		final String logDirectory = config.getProperty(LOGDIRECTORY_PROPERTY_NAME,</span>
				DEFAULT_LOGDIRECTORY);
<span class="nc" id="L180">		LOGGER.config(&quot;Logging Level '&quot; + level + &quot;'&quot;);</span>
<span class="nc" id="L181">		LOGGER.config(&quot;Log directory '&quot; + logDirectory + &quot;'&quot;);</span>

<span class="nc" id="L183">		Logger rootLogger = Logger.getLogger(&quot;&quot;);</span>
<span class="nc" id="L184">		rootLogger.setLevel(level);</span>

		try {
<span class="nc" id="L187">			File logDirectoryFile = new File(logDirectory);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">			if (!logDirectoryFile.exists()) {</span>
<span class="nc" id="L189">				LOGGER.fine(&quot;Creating log directory&quot;);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">				if (!logDirectoryFile.mkdirs()) {</span>
<span class="nc" id="L191">					LOGGER.warning(&quot;Unable to create log directory&quot;);</span>
				}
			}

			// filepattern, maxBytesPerFile, maxFiles, append
			// FileHandler handler = new FileHandler(logFile, 100000, 10, true);
<span class="nc" id="L197">			Handler handler = new SimpleLogFileHandler(logDirectoryFile,</span>
					new SimpleDateFormat(DEFAULT_LOGFILE));
<span class="nc" id="L199">			handler.setLevel(level);</span>
<span class="nc" id="L200">			rootLogger.addHandler(handler);</span>
<span class="nc" id="L201">		} catch (Exception e) {</span>
<span class="nc" id="L202">			LOGGER.log(Level.WARNING, &quot;Unable to create log file handler&quot;, e);</span>
<span class="nc" id="L203">		}</span>

<span class="nc" id="L205">		String redirectConsole = config.getProperty(</span>
				CONSOLEREDIRECT_PROPERTY_NAME, DEFAULT_CONSOLEREDIRECT);
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if (!redirectConsole.equals(DEFAULT_CONSOLEREDIRECT)) {</span>
			// default is off, so enable
<span class="nc" id="L209">			System.err.println(&quot;Redirecting STDOUT and STDERR to log file&quot;);</span>
<span class="nc" id="L210">			System.setOut(new PrintStream(new LoggingOutputStream(Logger</span>
<span class="nc" id="L211">					.getLogger(&quot;stdout&quot;), StdOutErrLevel.STDOUT)));</span>
<span class="nc" id="L212">			System.setErr(new PrintStream(new LoggingOutputStream(Logger</span>
<span class="nc" id="L213">					.getLogger(&quot;stderr&quot;), StdOutErrLevel.STDERR)));</span>
		} else {
<span class="nc" id="L215">			ConsoleHandler handler = new ConsoleHandler();</span>
<span class="nc" id="L216">			handler.setLevel(level);</span>
<span class="nc" id="L217">			rootLogger.addHandler(handler);</span>
		}

		Formatter formatter;
<span class="nc" id="L221">		String logFormat = config.getProperty(</span>
				LOGFORMAT_PROPERTY_NAME, DEFAULT_LOGFORMAT);
<span class="nc bnc" id="L223" title="All 2 branches missed.">		if (logFormat.equals(LOGFORMAT_SIMPLE)) {</span>
			// built in simple formatter
<span class="nc" id="L225">			formatter = new SimpleFormatter();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">		} else if (logFormat.equals(LOGFORMAT_XML)) {</span>
			// built in xml formatter
<span class="nc" id="L228">			formatter = new XMLFormatter();</span>
		} else {
			// pdl style simple formatter
<span class="nc" id="L231">			formatter = new SimpleLogFormatter();</span>
		}
<span class="nc bnc" id="L233" title="All 2 branches missed.">		for (Handler handler : rootLogger.getHandlers()) {</span>
<span class="nc" id="L234">			handler.setFormatter(formatter);</span>
		}
<span class="nc" id="L236">	}</span>

	public static void main(final String[] args) throws Exception {
<span class="nc" id="L239">		StringBuffer argumentList = new StringBuffer();</span>
<span class="nc" id="L240">		boolean configTest = false;</span>

<span class="nc" id="L242">		String className = null;</span>

		// use default config file
<span class="nc" id="L245">		File configFile = new File(DEFAULT_CONFIGFILE);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">		for (String arg : args) {</span>
<span class="nc" id="L247">			argumentList.append(arg).append(&quot; &quot;);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">			if (arg.startsWith(CONFIGFILE_ARGUMENT)) {</span>
				// unless config file argument provided
<span class="nc" id="L250">				configFile = new File(arg.replace(CONFIGFILE_ARGUMENT, &quot;&quot;));</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">			} else if (arg.equals(CONFIG_TEST_ARGUMENT)) {</span>
<span class="nc" id="L252">				configTest = true;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">			} else if (arg.startsWith(MAINCLASS_ARGUMENT)) {</span>
<span class="nc" id="L254">				className = arg.replace(MAINCLASS_ARGUMENT, &quot;&quot;);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">			} else if (arg.equals(VERSION_ARGUMENT)) {</span>
<span class="nc" id="L256">				System.err.println(&quot;Product Distribution Client&quot;);</span>
<span class="nc" id="L257">				System.err.println(ProductClient.RELEASE_VERSION);</span>
<span class="nc" id="L258">				System.exit(0);</span>
			}
		}

<span class="nc" id="L262">		Bootstrap bootstrap = new Bootstrap();</span>

		// load configuration file
<span class="nc" id="L265">		Config config = bootstrap.loadConfig(configFile);</span>

		// set global config object
<span class="nc" id="L268">		Config.setConfig(config);</span>

		// setup logging based on configuration
<span class="nc" id="L271">		bootstrap.setupLogging(config);</span>

		// java and os information
<span class="nc" id="L274">		LOGGER.config(&quot;java.vendor = &quot; + System.getProperty(&quot;java.vendor&quot;));</span>
<span class="nc" id="L275">		LOGGER.config(&quot;java.version = &quot; + System.getProperty(&quot;java.version&quot;));</span>
<span class="nc" id="L276">		LOGGER.config(&quot;java.home = &quot; + System.getProperty(&quot;java.home&quot;));</span>
<span class="nc" id="L277">		LOGGER.config(&quot;os.arch = &quot; + System.getProperty(&quot;os.arch&quot;));</span>
<span class="nc" id="L278">		LOGGER.config(&quot;os.name = &quot; + System.getProperty(&quot;os.name&quot;));</span>
<span class="nc" id="L279">		LOGGER.config(&quot;os.version = &quot; + System.getProperty(&quot;os.version&quot;));</span>
<span class="nc" id="L280">		LOGGER.config(&quot;user.dir = &quot; + System.getProperty(&quot;user.dir&quot;));</span>
<span class="nc" id="L281">		LOGGER.config(&quot;user.name = &quot; + System.getProperty(&quot;user.name&quot;));</span>

		// log command line arguments
<span class="nc" id="L284">		LOGGER.fine(&quot;Command line arguments: &quot; + argumentList.toString().trim());</span>

		// configure whether tracker updates are sent.
<span class="nc" id="L287">		String enableTrackerProperty = config</span>
<span class="nc" id="L288">				.getProperty(ENABLE_TRACKER_PROPERTY_NAME);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">		if (Boolean.valueOf(enableTrackerProperty)) {</span>
<span class="nc" id="L290">			LOGGER.warning(&quot;Enabled tracker updates,&quot;</span>
					+ &quot; this is usually not a good idea.&quot;);
<span class="nc" id="L292">			ProductTracker.setTrackerEnabled(true);</span>
		}

		// lookup main class
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (className == null) {</span>
			// no argument specified, check configuration
<span class="nc" id="L298">			className = config.getProperty(MAINCLASS_PROPERTY_NAME,</span>
					DEFAULT_MAINCLASS);
		}

		// invoke main class main(String[] args) method
<span class="nc" id="L303">		LOGGER.config(&quot;Loading main class &quot; + className);</span>
<span class="nc" id="L304">		Bootstrappable main = null;</span>
		try {
<span class="nc" id="L306">			main = (Bootstrappable) Class.forName(className)</span>
<span class="nc" id="L307">					.getConstructor().newInstance();</span>
<span class="nc" id="L308">		} catch (ClassCastException cce) {</span>
<span class="nc" id="L309">			LOGGER.log(Level.SEVERE,</span>
					&quot;Main class must implement the Bootstrappable interface&quot;,
					cce);
<span class="nc" id="L312">			System.exit(1);</span>
<span class="nc" id="L313">		}</span>

		// use the configurable interface when available
<span class="nc bnc" id="L316" title="All 2 branches missed.">		if (main instanceof Configurable) {</span>
<span class="nc" id="L317">			Configurable configurable = ((Configurable) main);</span>
<span class="nc" id="L318">			configurable.setName(&quot;main&quot;);</span>
			try {
<span class="nc" id="L320">				configurable.configure(config);</span>
<span class="nc" id="L321">			} catch (Exception e) {</span>
<span class="nc" id="L322">				LOGGER.log(Level.SEVERE, &quot;Exception loading configuration &quot;, e);</span>
<span class="nc" id="L323">				System.exit(1);</span>
<span class="nc" id="L324">			}</span>
		}

		// configuration loaded okay
<span class="nc" id="L328">		LOGGER.config(&quot;Configuration loaded&quot;);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">		if (configTest) {</span>
			// exit successfully
<span class="nc" id="L331">			System.exit(0);</span>
		}

		// run main instance
<span class="nc" id="L335">		LOGGER.config(&quot;Bootstrap complete, running main class\n&quot;);</span>
		try {
<span class="nc" id="L337">			main.run(args);</span>
<span class="nc" id="L338">		} catch (Exception e) {</span>
<span class="nc" id="L339">			LOGGER.log(Level.SEVERE, &quot;Main class threw exception, exiting&quot;, e);</span>
<span class="nc" id="L340">			System.exit(Bootstrappable.RUN_EXCEPTION_EXIT_CODE);</span>
<span class="nc" id="L341">		}</span>
<span class="nc" id="L342">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>