<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebSocketNotificationReceiver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.distribution</a> &gt; <span class="el_source">WebSocketNotificationReceiver.java</span></div><h1>WebSocketNotificationReceiver.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.distribution;

import gov.usgs.util.Config;
import gov.usgs.util.FileUtils;
import gov.usgs.util.StreamUtils;

import javax.json.Json;
import javax.json.JsonObject;
import javax.json.JsonReader;
import javax.websocket.CloseReason;
import javax.websocket.Session;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.InputStream;
import java.net.URI;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Receives notifications from an arbitrary web socket.
 */
<span class="fc" id="L22">public class WebSocketNotificationReceiver extends DefaultNotificationReceiver implements WebSocketListener {</span>

<span class="fc" id="L24">  public static final Logger LOGGER = Logger</span>
<span class="fc" id="L25">          .getLogger(WebSocketNotificationReceiver.class.getName());</span>

  public static final String SERVER_HOST_PROPERTY = &quot;serverHost&quot;;
  public static final String SERVER_PORT_PROPERTY = &quot;serverPort&quot;;
  public static final String SERVER_PATH_PROPERTY = &quot;serverPath&quot;;
  public static final String SEQUENCE_PROPERTY = &quot;sequence&quot;;
  public static final String TIMESTAMP_PROPERTY = &quot;timestamp&quot;;
  public static final String TRACKING_FILE_NAME_PROPERTY = &quot;trackingFileName&quot;;
  public static final String CONNECT_ATTEMPTS_PROPERTY = &quot;connectAttempts&quot;;
  public static final String CONNECT_TIMEOUT_PROPERTY = &quot;connectTimeout&quot;;
  public static final String RETRY_ON_CLOSE_PROPERTY = &quot;retryOnClose&quot;;

  public static final String DEFAULT_SERVER_HOST = &quot;http://www.google.com&quot;;
  public static final String DEFAULT_SERVER_PORT = &quot;4222&quot;;
  public static final String DEFAULT_SERVER_PATH = &quot;/sequence/&quot;;
  public static final String DEFAULT_TRACKING_FILE_NAME = &quot;data/WebSocketReceiverInfo&quot;;
  public static final String DEFAULT_CONNECT_ATTEMPTS = &quot;5&quot;;
  public static final String DEFAULT_CONNECT_TIMEOUT = &quot;1000&quot;;
  public static final String DEFAULT_RETRY_ON_CLOSE = &quot;true&quot;;

  public static final String ATTRIBUTE_DATA = &quot;data&quot;;

  private String serverHost;
  private String serverPort;
  private String serverPath;
  private String trackingFileName;
  private int attempts;
  private long timeout;
  private boolean retryOnClose;

  private WebSocketClient client;
<span class="fc" id="L56">  private String sequence = &quot;0&quot;;</span>


  @Override
  public void configure(Config config) throws Exception {
<span class="nc" id="L61">    super.configure(config);</span>

<span class="nc" id="L63">    serverHost = config.getProperty(SERVER_HOST_PROPERTY, DEFAULT_SERVER_HOST);</span>
<span class="nc" id="L64">    serverPort = config.getProperty(SERVER_PORT_PROPERTY, DEFAULT_SERVER_PORT);</span>
<span class="nc" id="L65">    serverPath = config.getProperty(SERVER_PATH_PROPERTY, DEFAULT_SERVER_PATH);</span>
<span class="nc" id="L66">    attempts = Integer.parseInt(config.getProperty(CONNECT_ATTEMPTS_PROPERTY, DEFAULT_CONNECT_ATTEMPTS));</span>
<span class="nc" id="L67">    timeout = Long.parseLong(config.getProperty(CONNECT_TIMEOUT_PROPERTY, DEFAULT_CONNECT_TIMEOUT));</span>
<span class="nc" id="L68">    retryOnClose = Boolean.parseBoolean(config.getProperty(RETRY_ON_CLOSE_PROPERTY, DEFAULT_RETRY_ON_CLOSE));</span>
<span class="nc" id="L69">    trackingFileName = config.getProperty(TRACKING_FILE_NAME_PROPERTY, DEFAULT_TRACKING_FILE_NAME);</span>
<span class="nc" id="L70">  }</span>

  /**
   * Reads a sequence from a tracking file if it exists. Otherwise, starting sequence is 0.
   * Connects to web socket
   * @throws Exception
   */
  @Override
  public void startup() throws Exception{
<span class="nc" id="L79">    super.startup();</span>

    //read sequence from tracking file if other parameters agree
<span class="nc" id="L82">    JsonObject json = readTrackingFile();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    if (json != null &amp;&amp;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            json.getString(SERVER_HOST_PROPERTY).equals(serverHost) &amp;&amp;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            json.getString(SERVER_PORT_PROPERTY).equals(serverPort) &amp;&amp;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            json.getString(SERVER_PATH_PROPERTY).equals(serverPath)) {</span>
<span class="nc" id="L87">      sequence = json.getString(SEQUENCE_PROPERTY);</span>
    }

    //open websocket
<span class="nc" id="L91">    client = new WebSocketClient(new URI(serverHost + &quot;:&quot; + serverPort + serverPath + sequence), this, attempts, timeout, true);</span>
<span class="nc" id="L92">  }</span>

  /**
   * Closes web socket
   * @throws Exception
   */
  @Override
  public void shutdown() throws Exception{
    //close socket
<span class="nc" id="L101">    client.shutdown();</span>
<span class="nc" id="L102">    super.shutdown();</span>
<span class="nc" id="L103">  }</span>

  /**
   * Writes tracking file to disc, storing latest sequence
   * @throws Exception
   */
  public void writeTrackingFile() throws Exception {
<span class="fc" id="L110">    JsonObject json = Json.createObjectBuilder()</span>
<span class="fc" id="L111">            .add(SERVER_HOST_PROPERTY,serverHost)</span>
<span class="fc" id="L112">            .add(SERVER_PATH_PROPERTY,serverPath)</span>
<span class="fc" id="L113">            .add(SERVER_PORT_PROPERTY,serverPort)</span>
<span class="fc" id="L114">            .add(SEQUENCE_PROPERTY,sequence)</span>
<span class="fc" id="L115">            .build();</span>

<span class="fc" id="L117">    FileUtils.writeFileThenMove(</span>
            new File(trackingFileName + &quot;_tmp.json&quot;),
            new File(trackingFileName + &quot;.json&quot;),
<span class="fc" id="L120">            json.toString().getBytes());</span>
<span class="fc" id="L121">  }</span>

  /**
   * Reads tracking file from disc
   * @return  JsonObject tracking file
   * @throws Exception
   */
  public JsonObject readTrackingFile() throws Exception {
<span class="fc" id="L129">    JsonObject json = null;</span>

<span class="fc" id="L131">    File trackingFile = new File(trackingFileName + &quot;.json&quot;);</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">    if (trackingFile.exists()) {</span>
<span class="fc" id="L133">      InputStream contents = new ByteArrayInputStream(FileUtils.readFile(trackingFile));</span>
<span class="fc" id="L134">      JsonReader jsonReader = Json.createReader(contents);</span>
<span class="fc" id="L135">      json = jsonReader.readObject();</span>
<span class="fc" id="L136">      jsonReader.close();</span>
    }
<span class="fc" id="L138">    return json;</span>
  }

  @Override
  public void onOpen(Session session) {
    // do nothing
<span class="nc" id="L144">  }</span>

  /**
   * Message handler function passed to WebSocketClient
   * Parses the message as JSON, receives the contained URL notification, and writes the tracking file.
   * @param message
   */
  @Override
  public void onMessage(String message) {
    JsonObject json;
<span class="fc" id="L154">    try (InputStream in = StreamUtils.getInputStream(message); JsonReader reader = Json.createReader(in)) {</span>
      //parse input as json
<span class="fc" id="L156">      json = reader.readObject();</span>
<span class="nc" id="L157">    } catch (Exception e) {</span>
<span class="nc" id="L158">      LOGGER.log(Level.WARNING, &quot;[&quot; + getName() + &quot;] exception while receiving notification; is it encoded as JSON? &quot;, e);</span>
<span class="nc" id="L159">      return;</span>
<span class="fc" id="L160">    }</span>
    try {
      //convert to URLNotification and receive
<span class="fc" id="L163">      JsonObject dataJson = json.getJsonObject(ATTRIBUTE_DATA);</span>
<span class="fc" id="L164">      URLNotification notification = URLNotificationJSONConverter.parseJSON(dataJson);</span>
<span class="fc" id="L165">      receiveNotification(notification);</span>

      //send heartbeat
<span class="nc" id="L168">      HeartbeatListener.sendHeartbeatMessage(getName(), &quot;nats notification timestamp&quot;, json.getString(TIMESTAMP_PROPERTY));</span>

      //write tracking file
<span class="nc" id="L171">      sequence = json.getJsonNumber(SEQUENCE_PROPERTY).toString();</span>
<span class="nc" id="L172">      writeTrackingFile();</span>
<span class="fc" id="L173">    } catch (Exception e) {</span>
<span class="fc" id="L174">      LOGGER.log(Level.WARNING, &quot;[&quot; + getName() + &quot;] exception while processing URLNotification &quot;, e);</span>
<span class="nc" id="L175">    }</span>
<span class="fc" id="L176">  }</span>

  @Override
  public void onClose(Session session, CloseReason closeReason) {
    // do nothing
<span class="nc" id="L181">  }</span>

  @Override
  public void onConnectFail() {
    // do nothing
<span class="nc" id="L186">  }</span>

  @Override
  public void onReconnectFail() {
    // do nothing
<span class="nc" id="L191">  }</span>

  public String getServerHost() {
<span class="nc" id="L194">    return serverHost;</span>
  }

  public void setServerHost(String serverHost) {
<span class="fc" id="L198">    this.serverHost = serverHost;</span>
<span class="fc" id="L199">  }</span>

  public String getServerPort() {
<span class="nc" id="L202">    return serverPort;</span>
  }

  public void setServerPort(String serverPort) {
<span class="fc" id="L206">    this.serverPort = serverPort;</span>
<span class="fc" id="L207">  }</span>

  public String getServerPath() {
<span class="nc" id="L210">    return serverPath;</span>
  }

  public void setServerPath(String serverPath) {
<span class="fc" id="L214">    this.serverPath = serverPath;</span>
<span class="fc" id="L215">  }</span>

  public String getTrackingFileName() {
<span class="nc" id="L218">    return trackingFileName;</span>
  }

  public void setTrackingFileName(String trackingFileName) {
<span class="fc" id="L222">    this.trackingFileName = trackingFileName;</span>
<span class="fc" id="L223">  }</span>

  public String getSequence() {
<span class="nc" id="L226">    return sequence;</span>
  }

  public void setSequence(String sequence) {
<span class="fc" id="L230">    this.sequence = sequence;</span>
<span class="fc" id="L231">  }</span>

  public int getAttempts() {
<span class="nc" id="L234">    return attempts;</span>
  }

  public void setAttempts(int attempts) {
<span class="nc" id="L238">    this.attempts = attempts;</span>
<span class="nc" id="L239">  }</span>

  public long getTimeout() {
<span class="nc" id="L242">    return timeout;</span>
  }

  public void setTimeout(long timeout) {
<span class="nc" id="L246">    this.timeout = timeout;</span>
<span class="nc" id="L247">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>